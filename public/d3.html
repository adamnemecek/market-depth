<html>
<head>
    <title>Bitcoin Market Depth</title>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <style type="text/css">
        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        .ask {
            fill: red;
        }

        .bid {
            fill: green;
        }

        .sell {
            fill: black;
        }

    </style>
</head>
<body>
<script type="text/javascript">

    var w = 1000;
    var h = 900;
    var padding = 40;


    function drawLineFor(type, svg, line) {
        svg.append("path")
                .attr("d", line(type))
                .attr("stroke", "blue")
                .attr("stroke-width", 2)
                .attr("fill", "none");
    }

    function drawCircles(svg, asks, xScale, yScale, elementClass, element) {

        svg.selectAll(element)
                .data(asks)
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                    return xScale(d[0]);
                })
                .attr("cy", function (d, i) {
                    var iterData = asks.slice(0, i);
                    var sum = d3.sum(iterData, function (d) {
                        return d[1];
                    })
                    return yScale(sum);
                })
                .attr("r", 2)
                .attr('class', elementClass);
    }


    function visualise(data, ticker) {
        console.log(ticker);
        var asks = data.asks;
        var bids = data.bids;


        var svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h)
                .call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoom));

        var asksMin = d3.min(asks, function (d) {
            return d[0];
        });
        var bidsMin = d3.min(bids, function (d) {
            return d[0];
        });
        var asksMax = d3.max(asks, function (d) {
            return d[0];
        });
        var bidsMax = d3.max(asks, function (d) {
            return d[0];
        });

        var min = d3.min([asksMin, bidsMin]);
        var max = d3.min([asksMax, bidsMax]);

        var domainArray = [ min, max ];

        var xScale = d3.scale.linear()
                .domain(domainArray)
                .range([padding, w - padding]);

        var yScale = d3.scale.linear()
                .domain([0, d3.sum(asks, function (d) {
                    return d[1];
                })])
                .range([h - padding, padding]);

        var askClass = 'ask';
        var bidClass = 'bid';
        drawCircles(svg, asks, xScale, yScale, askClass, "circle");
        drawCircles(svg, bids, xScale, yScale, bidClass, "rect");


        var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom")
                .ticks(20);  //Set rough # of ticks


        svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (h - padding) + ")")
                .call(xAxis);


        var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left")
                .ticks(20);

        svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + padding + ",0)")
                .call(yAxis);

        var line = d3.svg.line()
                .x(function (d) {
                    return xScale(d[0]);
                })
                .y(function (d) {
                    return yScale(d[1]);
                });

        function zoom() {
            console.log('zoom');
            svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }

        svg.append("line")
                .attr("x1", xScale(ticker.ticker.sell))
                .attr("y1", 0+padding)
                .attr("x2", xScale(ticker.ticker.sell))
                .attr("y2", h-padding)
                .attr("stroke-width", 2)
                .attr("stroke", "black");

        svg.append("line")
                .attr("x1", xScale(ticker.ticker.buy))
                .attr("y1", 0+padding)
                .attr("x2", xScale(ticker.ticker.buy))
                .attr("y2", h-padding)
                .attr("stroke-width", 2)
                .attr("stroke", "yellow");


        drawLineFor(asks, svg, line);
        drawLineFor(bids, svg, line);

    }


    function getDataAndRender() {
        var ticker;
        d3.json('/ticker.json', function (data) {
            ticker = data;
        });

        d3.json('/depth.json', function (data) {
            visualise(data, ticker);
        });
    }
    getDataAndRender();

</script>
</body>
</html>


